<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - HelloRun</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/login.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <%- include('../layouts/nav') %>
  
  <main class="auth-page">
    <div class="auth-container">
      <div class="auth-card" style="padding: 2rem 2rem;">
        <% if (locals.redirectToLogin) { %>
          <!-- Success State with Countdown -->
          <div class="success-state" style="text-align: center;">
            <div class="success-icon-wrapper" style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; animation: scaleIn 0.5s ease;">
              <i data-lucide="check-circle" style="width: 48px; height: 48px; color: white;"></i>
            </div>
            
            <h1 style="font-size: 1.75rem; margin-bottom: 0.5rem; color: #10b981;">Password Reset Successful!</h1>
            <p style="color: #64748b; margin-bottom: 2rem; font-size: 1rem;">
              Your password has been updated. A confirmation email has been sent to your inbox.
            </p>
            
            <div class="countdown-container" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
              <p style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.875rem;">Redirecting to login in</p>
              <div class="countdown-number" id="countdown" style="font-size: 3rem; font-weight: 700; color: #FA9A4B; font-family: 'Poppins', sans-serif;">3</div>
              <div class="progress-bar" style="width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden; margin-top: 1rem;">
                <div class="progress-fill" id="progressBar" style="height: 100%; width: 100%; background: linear-gradient(135deg, #FA9A4B 0%, #E0A46A 100%); transition: width 1s linear;"></div>
              </div>
            </div>
            
            <p style="color: #94a3b8; font-size: 0.875rem;">
              Or <a href="/login" style="color: #FA9A4B; text-decoration: none; font-weight: 600;">click here to login now</a>
            </p>
          </div>
        <% } else { %>
          <!-- Regular Reset Form -->
          <div class="auth-icon-wrapper" style="width: 56px; height: 56px; background: linear-gradient(135deg, #FA9A4B 0%, #E0A46A 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
            <i data-lucide="key" style="width: 28px; height: 28px; color: white;"></i>
          </div>
          
          <h1 style="font-size: 1.75rem; margin-bottom: 0.25rem;">Reset Password</h1>
          <p class="auth-subtitle" style="margin-bottom: 1.5rem;">Enter your new password below</p>
          
          <% if (locals.error) { %>
            <div class="alert alert-error" style="padding: 0.75rem; margin-bottom: 1rem;">
              <i data-lucide="alert-circle"></i>
              <span><%= error %></span>
            </div>
          <% } %>
          
          <% if (locals.token) { %>
            <form action="/reset-password/<%= token %>" method="POST" class="auth-form" id="resetPasswordForm" novalidate style="gap: 0.75rem;">
              <!-- New Password -->
              <div class="form-group password-input" style="margin-bottom: 0;">
                <input type="password" id="password" name="password" placeholder=" " required minlength="8" autocomplete="new-password">
                <label for="password">New Password</label>
                <button type="button" class="toggle-password" data-target="password" aria-label="Toggle password visibility">
                  <i data-lucide="eye" class="eye-icon"></i>
                </button>
              </div>
              
              <!-- Password Strength Indicator -->
              <div class="password-strength" id="passwordStrength" style="display: none; margin-top: -0.5rem; margin-bottom: 0.5rem;">
                <div class="strength-bar" style="height: 3px; background: #e2e8f0; border-radius: 2px; overflow: hidden; margin-bottom: 0.25rem;">
                  <div class="strength-fill" id="strengthFill" style="height: 100%; width: 0%; transition: all 0.3s ease; background: #ef4444;"></div>
                </div>
                <small class="strength-text" id="strengthText" style="font-size: 0.8rem; color: #64748b;"></small>
              </div>
              <small class="form-error" id="passwordError" style="display: none; color: #dc2626; font-size: 0.8rem; margin-top: -0.5rem; margin-bottom: 0.5rem;"></small>
              
              <!-- Confirm Password -->
              <div class="form-group password-input" style="margin-bottom: 0;">
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder=" " required minlength="8" autocomplete="new-password">
                <label for="confirmPassword">Confirm Password</label>
                <button type="button" class="toggle-password" data-target="confirmPassword" aria-label="Toggle password visibility">
                  <i data-lucide="eye" class="eye-icon"></i>
                </button>
              </div>
              <small class="form-error" id="confirmPasswordError" style="display: none; color: #dc2626; font-size: 0.8rem; margin-top: -0.5rem; margin-bottom: 0.5rem;"></small>
              
              <button type="submit" class="btn btn-full" id="submitBtn" style="margin-top: 0.5rem;">
                <span class="btn-text">Reset Password</span>
                <span class="btn-loader" style="display: none;">
                  <i data-lucide="loader-2" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i>
                  Resetting...
                </span>
              </button>
            </form>
          <% } else { %>
            <p class="auth-switch" style="margin-top: 1rem;">
              <a href="/forgot-password">Request a new reset link</a>
            </p>
          <% } %>
          
          <p class="auth-switch" style="margin-top: 1rem; margin-bottom: 0;">
            Remember your password? <a href="/login">Log in</a>
          </p>
        <% } %>
      </div>
    </div>
  </main>
  
  <%- include('../layouts/footer') %>
  
  <script src="/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();

      // ========================================
      // COUNTDOWN REDIRECT
      // ========================================
      <% if (locals.redirectToLogin) { %>
        let countdown = 3;
        const countdownElement = document.getElementById('countdown');
        const progressBar = document.getElementById('progressBar');
        
        const countdownInterval = setInterval(() => {
          countdown--;
          if (countdownElement) {
            countdownElement.textContent = countdown;
          }
          if (progressBar) {
            progressBar.style.width = ((countdown / 3) * 100) + '%';
          }
          
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            window.location.href = '/login';
          }
        }, 1000);
      <% } %>

      // ========================================
      // PASSWORD TOGGLE
      // ========================================
      document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const targetId = this.getAttribute('data-target');
          const passwordInput = document.getElementById(targetId);
          
          if (!passwordInput) {
            console.error('Password input not found:', targetId);
            return;
          }
          
          const isPassword = passwordInput.type === 'password';
          passwordInput.type = isPassword ? 'text' : 'password';
          
          const iconElement = this.querySelector('[data-lucide]');
          if (iconElement) {
            iconElement.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
            lucide.createIcons();
          }
        });
      });

      // ========================================
      // PASSWORD STRENGTH INDICATOR
      // ========================================
      const passwordInput = document.getElementById('password');
      const strengthBar = document.getElementById('passwordStrength');
      const strengthFill = document.getElementById('strengthFill');
      const strengthText = document.getElementById('strengthText');
      
      if (passwordInput && strengthBar && strengthFill && strengthText) {
        passwordInput.addEventListener('input', function() {
          const password = this.value;
          
          if (password.length === 0) {
            strengthBar.style.display = 'none';
            return;
          }
          
          strengthBar.style.display = 'block';
          
          let strength = 0;
          
          if (password.length >= 8) strength++;
          if (/[A-Z]/.test(password)) strength++;
          if (/[a-z]/.test(password)) strength++;
          if (/[0-9]/.test(password)) strength++;
          if (/[^A-Za-z0-9]/.test(password)) strength++;
          
          const strengthLevels = [
            { width: '20%', color: '#ef4444', text: 'Very Weak' },
            { width: '20%', color: '#ef4444', text: 'Very Weak' },
            { width: '40%', color: '#f97316', text: 'Weak' },
            { width: '60%', color: '#eab308', text: 'Fair' },
            { width: '80%', color: '#3b82f6', text: 'Good' },
            { width: '100%', color: '#10b981', text: 'Strong' }
          ];
          
          const level = strengthLevels[strength];
          strengthFill.style.width = level.width;
          strengthFill.style.backgroundColor = level.color;
          strengthText.textContent = level.text;
          strengthText.style.color = level.color;
        });
      }

      // ========================================
      // REAL-TIME PASSWORD MATCH VALIDATION
      // ========================================
      const confirmPassword = document.getElementById('confirmPassword');
      
      if (confirmPassword && passwordInput) {
        confirmPassword.addEventListener('input', function() {
          const confirmError = document.getElementById('confirmPasswordError');
          
          if (this.value && passwordInput.value !== this.value) {
            confirmError.textContent = 'Passwords do not match';
            confirmError.style.display = 'block';
            this.parentElement.classList.add('error');
          } else {
            confirmError.textContent = '';
            confirmError.style.display = 'none';
            this.parentElement.classList.remove('error');
          }
        });
      }

      // ========================================
      // FORM VALIDATION
      // ========================================
      const form = document.getElementById('resetPasswordForm');
      const submitBtn = document.getElementById('submitBtn');
      
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          document.querySelectorAll('.form-error').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
          });
          document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

          let isValid = true;

          let strength = 0;
          const pwd = passwordInput.value;
          if (pwd.length >= 8) strength++;
          if (/[A-Z]/.test(pwd)) strength++;
          if (/[a-z]/.test(pwd)) strength++;
          if (/[0-9]/.test(pwd)) strength++;
          
          if (strength < 4) {
            showError('passwordError', 'Password must contain uppercase, lowercase, and a number');
            passwordInput.parentElement.classList.add('error');
            isValid = false;
          }

          if (passwordInput.value !== confirmPassword.value) {
            showError('confirmPasswordError', 'Passwords do not match');
            confirmPassword.parentElement.classList.add('error');
            isValid = false;
          }

          if (isValid) {
            submitBtn.disabled = true;
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            if (btnText && btnLoader) {
              btnText.style.display = 'none';
              btnLoader.style.display = 'inline-flex';
              btnLoader.style.alignItems = 'center';
              btnLoader.style.gap = '0.5rem';
            }
            
            lucide.createIcons();
            form.submit();
          } else {
            form.classList.add('shake');
            setTimeout(() => form.classList.remove('shake'), 500);
          }
        });
      }

      function showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.style.display = 'block';
        }
      }
    });
  </script>
  
  <style>
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    @keyframes scaleIn {
      from {
        transform: scale(0);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    .form-error {
      display: block;
    }
    
    .form-group.error input,
    .password-input.error input {
      border-color: #dc2626 !important;
    }
    
    .auth-card {
      max-height: calc(100vh - 180px);
      overflow-y: auto;
    }
    
    .btn-loader {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
  </style>
</body>
</html>