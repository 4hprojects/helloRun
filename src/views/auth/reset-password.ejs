<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../layouts/head', { title: 'Reset Password - helloRun' }) %>
  <link rel="stylesheet" href="/css/reset-password.css">
</head>
<body>
  <%- include('../layouts/nav') %>
  
  <main class="auth-page">
    <div class="auth-container">
      <div class="auth-card animate-in">
        
        <% if (locals.redirectToLogin) { %>
          <!-- SUCCESS STATE -->
          <div class="success-state">
            <div class="success-icon">
              <i data-lucide="check-circle"></i>
            </div>
            <h1>Password Reset!</h1>
            <p class="auth-subtitle">Your password has been successfully reset.</p>
            <p>Redirecting to login in <span id="countdown">5</span> seconds...</p>
            <div class="progress-bar">
              <div class="progress-fill" id="progressBar"></div>
            </div>
            <a href="/login" id="redirectLink">Login now â†’</a>
          </div>
          
        <% } else if (locals.token) { %>
          <!-- RESET FORM -->
          <div class="auth-header">
            <div class="auth-icon">
              <i data-lucide="key"></i>
            </div>
            <h1>Reset Password</h1>
            <p class="auth-subtitle">Create a strong password for your account</p>
          </div>
          
          <% if (locals.error) { %>
            <div class="alert alert-error" role="alert">
              <i data-lucide="alert-circle"></i>
              <span><%= error %></span>
            </div>
          <% } %>
          
          <form action="/reset-password/<%= token %>" method="POST" id="resetPasswordForm" novalidate>
            <!-- New Password -->
            <div class="form-group">
              <div class="input-wrapper">
                <input 
                  type="password" 
                  id="password" 
                  name="password" 
                  placeholder=" " 
                  required 
                  minlength="8"
                  maxlength="128"
                  autocomplete="new-password"
                  aria-describedby="passwordError passwordStrength"
                  aria-invalid="false"
                >
                <label for="password">New Password</label>
                <button 
                  type="button" 
                  class="toggle-password" 
                  id="togglePassword"
                  aria-label="Show password"
                  tabindex="-1"
                >
                  <i data-lucide="eye"></i>
                </button>
              </div>
              <small class="field-error" id="passwordError" role="alert"></small>
              
              <!-- Strength Indicator -->
              <div class="password-strength" id="passwordStrength">
                <div class="strength-bar">
                  <div class="strength-fill" id="strengthFill"></div>
                </div>
                <small class="strength-text" id="strengthText">Strength: Very Weak</small>
              </div>
            </div>
            
            <!-- Confirm Password -->
            <div class="form-group">
              <div class="input-wrapper">
                <input 
                  type="password" 
                  id="confirmPassword" 
                  name="confirmPassword" 
                  placeholder=" " 
                  required 
                  minlength="8"
                  maxlength="128"
                  autocomplete="new-password"
                  aria-describedby="confirmPasswordError"
                  aria-invalid="false"
                >
                <label for="confirmPassword">Confirm Password</label>
                <button 
                  type="button" 
                  class="toggle-password" 
                  id="toggleConfirmPassword"
                  aria-label="Show password"
                  tabindex="-1"
                >
                  <i data-lucide="eye"></i>
                </button>
              </div>
              <small class="field-error" id="confirmPasswordError" role="alert"></small>
            </div>
            
            <!-- Submit -->
            <button type="submit" class="btn-reset" id="submitBtn" disabled>
              <span class="btn-text">Reset Password</span>
              <span class="btn-spinner" aria-hidden="true">
                <span class="spinner"></span>
              </span>
            </button>
          </form>
          
          <div class="back-to-login">
            <a href="/login">
              <i data-lucide="arrow-left"></i>
              Back to Login
            </a>
          </div>
          
        <% } else { %>
          <!-- INVALID TOKEN -->
          <div class="error-state">
            <div class="error-state-icon">
              <i data-lucide="alert-triangle"></i>
            </div>
            <h3>Invalid or Expired Link</h3>
            <p>This password reset link is no longer valid. Please request a new one.</p>
            <a href="/forgot-password" class="btn-secondary">Request New Link</a>
          </div>
        <% } %>
        
      </div>
    </div>
  </main>
  
  <!-- Screen reader live region -->
  <div id="liveRegion" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>
  
  <%- include('../layouts/footer') %>
  
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="/js/reset-password.js"></script>
</body>
</html>