<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../layouts/head', { title: title }) %>
  <link rel="stylesheet" href="/css/create-event.css">
</head>
<body>
  <%- include('../layouts/nav') %>

  <main class="create-event-page">
    <section class="create-event-shell">
      <header class="page-header">
        <h1>Edit Event</h1>
        <p>Update event details using the same schema rules as event creation.</p>
      </header>

      <% if (message) { %>
        <div class="status-note status-note-<%= message.type %>" role="status">
          <i data-lucide="<%= message.type === 'success' ? 'check-circle' : 'alert-circle' %>"></i>
          <div>
            <strong><%= message.type === 'success' ? 'Success' : 'Attention' %></strong>
            <p><%= message.text %></p>
          </div>
        </div>
      <% } %>

      <% if (Object.keys(errors || {}).length) { %>
        <div class="form-errors" role="alert">
          <strong>Please fix the highlighted fields before saving.</strong>
        </div>
      <% } %>

      <form class="create-event-form" method="POST" action="/organizer/events/<%= event._id %>/edit" enctype="multipart/form-data" novalidate>
        <div class="form-section">
          <div class="section-title">Core Details</div>
          <div class="form-grid">
            <div class="form-group <%= errors.title ? 'has-error' : '' %>">
              <label for="title">Event Title *</label>
              <input id="title" name="title" type="text" value="<%= formData.title %>">
              <% if (errors.title) { %><small class="error-text"><%= errors.title %></small><% } %>
            </div>

            <div class="form-group">
              <label for="organiserName">Organizer Name</label>
              <input id="organiserName" name="organiserName" type="text" value="<%= formData.organiserName %>">
            </div>

            <div class="form-group form-group-full <%= errors.description ? 'has-error' : '' %>">
              <label for="description">Description *</label>
              <textarea id="description" name="description" rows="4"><%= formData.description %></textarea>
              <% if (errors.description) { %><small class="error-text"><%= errors.description %></small><% } %>
            </div>

            <div class="form-group form-group-full <%= errors.eventType ? 'has-error' : '' %>">
              <label for="eventType">Event Type *</label>
              <select id="eventType" name="eventType" required>
                <option value="">Select event type</option>
                <option value="virtual" <%= formData.eventType === 'virtual' ? 'selected' : '' %>>Virtual (Virtual run only)</option>
                <option value="onsite" <%= formData.eventType === 'onsite' ? 'selected' : '' %>>On-site (On-site only)</option>
                <option value="hybrid" <%= formData.eventType === 'hybrid' ? 'selected' : '' %>>Hybrid (Both virtual and on-site)</option>
              </select>
              <% if (errors.eventType) { %><small class="error-text"><%= errors.eventType %></small><% } %>
            </div>

            <div class="form-group form-group-full <%= errors.raceDistances ? 'has-error' : '' %>">
              <label>Race Distances *</label>
              <div class="checkbox-row">
                <% const selectedDistances = formData.raceDistancePresets || []; %>
                <label><input type="checkbox" name="raceDistancePresets" value="3K" <%= selectedDistances.includes('3K') ? 'checked' : '' %>> 3K</label>
                <label><input type="checkbox" name="raceDistancePresets" value="5K" <%= selectedDistances.includes('5K') ? 'checked' : '' %>> 5K</label>
                <label><input type="checkbox" name="raceDistancePresets" value="10K" <%= selectedDistances.includes('10K') ? 'checked' : '' %>> 10K</label>
                <label><input type="checkbox" name="raceDistancePresets" value="21K" <%= selectedDistances.includes('21K') ? 'checked' : '' %>> 21K</label>
              </div>
              <label for="raceDistanceCustom" style="margin-top:0.5rem;">Custom Distances (comma-separated)</label>
              <input id="raceDistanceCustom" name="raceDistanceCustom" type="text" value="<%= formData.raceDistanceCustom || '' %>" placeholder="e.g., 42K, 50K">
              <small class="field-hint">Final values are normalized like 3K, 5K, 10K.</small>
              <% if (errors.raceDistances) { %><small class="error-text"><%= errors.raceDistances %></small><% } %>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Waiver (Required)</div>
          <div class="form-grid">
            <div class="form-group form-group-full <%= errors.waiverTemplate ? 'has-error' : '' %>">
              <label for="waiverTemplate">Waiver Template HTML *</label>
              <div class="waiver-toolbar">
                <button type="button" id="resetWaiverBtn" class="btn btn-outline">Reset to Default Waiver</button>
              </div>
              <textarea
                id="waiverTemplate"
                name="waiverTemplate"
                rows="14"
                placeholder="Enter waiver HTML template"
              ><%= formData.waiverTemplate %></textarea>
              <small class="field-hint">
                Use placeholders: <code>{{ORGANIZER_NAME}}</code> and <code>{{EVENT_TITLE}}</code>.
                Changing this will bump waiver version for new registrants.
              </small>
              <% if (errors.waiverTemplate) { %><small class="error-text"><%= errors.waiverTemplate %></small><% } %>
            </div>

            <div class="form-group form-group-full">
              <label>Waiver Preview</label>
              <div id="waiverPreview" class="waiver-preview-box"></div>
              <small class="field-hint">
                Preview replaces placeholders using current Organizer Name and Event Title values.
              </small>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Schedule</div>
          <div class="form-grid">
            <div class="form-group <%= errors.registrationOpenAt ? 'has-error' : '' %>">
              <label for="registrationOpenAt">Registration Open *</label>
              <input id="registrationOpenAt" name="registrationOpenAt" type="datetime-local" value="<%= formData.registrationOpenAt %>">
              <% if (errors.registrationOpenAt) { %><small class="error-text"><%= errors.registrationOpenAt %></small><% } %>
            </div>

            <div class="form-group <%= errors.registrationCloseAt ? 'has-error' : '' %>">
              <label for="registrationCloseAt">Registration Close *</label>
              <input id="registrationCloseAt" name="registrationCloseAt" type="datetime-local" value="<%= formData.registrationCloseAt %>">
              <% if (errors.registrationCloseAt) { %><small class="error-text"><%= errors.registrationCloseAt %></small><% } %>
            </div>

            <div class="form-group <%= errors.eventStartAt ? 'has-error' : '' %>">
              <label for="eventStartAt">Event Start *</label>
              <input id="eventStartAt" name="eventStartAt" type="datetime-local" value="<%= formData.eventStartAt %>">
              <% if (errors.eventStartAt) { %><small class="error-text"><%= errors.eventStartAt %></small><% } %>
            </div>

            <div class="form-group <%= errors.eventEndAt ? 'has-error' : '' %>">
              <label for="eventEndAt">Event End *</label>
              <input id="eventEndAt" name="eventEndAt" type="datetime-local" value="<%= formData.eventEndAt %>">
              <% if (errors.eventEndAt) { %><small class="error-text"><%= errors.eventEndAt %></small><% } %>
            </div>
          </div>
        </div>

        <div class="form-section location-section" style="display: none;">
          <div class="section-title">Location (required for on-site/hybrid)</div>
          <div class="form-grid">
            <div class="form-group <%= errors.venueName ? 'has-error' : '' %>">
              <label for="venueName">Venue Name</label>
              <input id="venueName" name="venueName" type="text" value="<%= formData.venueName %>">
              <% if (errors.venueName) { %><small class="error-text"><%= errors.venueName %></small><% } %>
            </div>

            <div class="form-group <%= errors.city ? 'has-error' : '' %>">
              <label for="city">City</label>
              <input id="city" name="city" type="text" value="<%= formData.city %>">
              <% if (errors.city) { %><small class="error-text"><%= errors.city %></small><% } %>
            </div>

            <div class="form-group form-group-full <%= errors.venueAddress ? 'has-error' : '' %>">
              <label for="venueAddress">Venue Address</label>
              <input id="venueAddress" name="venueAddress" type="text" value="<%= formData.venueAddress %>">
              <% if (errors.venueAddress) { %><small class="error-text"><%= errors.venueAddress %></small><% } %>
            </div>

            <div class="form-group">
              <label for="province">Province/State</label>
              <input id="province" name="province" type="text" value="<%= formData.province %>">
            </div>

            <div class="form-group <%= errors.country ? 'has-error' : '' %>">
              <label for="country">Country</label>
              <% const countryCodes = (countries || []).map((item) => item.code); %>
              <select id="country" name="country">
                <option value="">Select country</option>
                <% (countries || []).forEach((item) => { %>
                  <option value="<%= item.code %>" <%= formData.country === item.code ? 'selected' : '' %>><%= item.name %></option>
                <% }); %>
                <% if (formData.country && !countryCodes.includes(formData.country)) { %>
                  <option value="<%= formData.country %>" selected><%= formData.country %> (legacy)</option>
                <% } %>
              </select>
              <% if (errors.country) { %><small class="error-text"><%= errors.country %></small><% } %>
            </div>

            <div class="form-group <%= errors.geoLat ? 'has-error' : '' %>">
              <label for="geoLat">Latitude (optional)</label>
              <input id="geoLat" name="geoLat" type="text" value="<%= formData.geoLat %>">
              <% if (errors.geoLat) { %><small class="error-text"><%= errors.geoLat %></small><% } %>
            </div>

            <div class="form-group <%= errors.geoLng ? 'has-error' : '' %>">
              <label for="geoLng">Longitude (optional)</label>
              <input id="geoLng" name="geoLng" type="text" value="<%= formData.geoLng %>">
              <% if (errors.geoLng) { %><small class="error-text"><%= errors.geoLng %></small><% } %>
              <% if (errors.geo) { %><small class="error-text"><%= errors.geo %></small><% } %>
            </div>
          </div>
        </div>

        <div class="form-section virtual-section" style="display: none;">
          <div class="section-title">Virtual Rules (required for virtual/hybrid)</div>
          <div class="form-grid">
            <div class="form-group <%= errors.virtualStartAt ? 'has-error' : '' %>">
              <label for="virtualStartAt">Virtual Window Start</label>
              <input id="virtualStartAt" name="virtualStartAt" type="datetime-local" value="<%= formData.virtualStartAt %>">
              <% if (errors.virtualStartAt) { %><small class="error-text"><%= errors.virtualStartAt %></small><% } %>
            </div>

            <div class="form-group <%= errors.virtualEndAt ? 'has-error' : '' %>">
              <label for="virtualEndAt">Virtual Window End</label>
              <input id="virtualEndAt" name="virtualEndAt" type="datetime-local" value="<%= formData.virtualEndAt %>">
              <% if (errors.virtualEndAt) { %><small class="error-text"><%= errors.virtualEndAt %></small><% } %>
            </div>

            <div class="form-group form-group-full <%= errors.proofTypesAllowed ? 'has-error' : '' %>">
              <label>Proof Types Allowed</label>
              <div class="checkbox-row">
                <% const selectedProofs = formData.proofTypesAllowed || []; %>
                <label><input type="checkbox" name="proofTypesAllowed" value="gps" <%= selectedProofs.includes('gps') ? 'checked' : '' %>> GPS</label>
                <label><input type="checkbox" name="proofTypesAllowed" value="photo" <%= selectedProofs.includes('photo') ? 'checked' : '' %>> Photo</label>
                <label><input type="checkbox" name="proofTypesAllowed" value="manual" <%= selectedProofs.includes('manual') ? 'checked' : '' %>> Manual</label>
              </div>
              <% if (errors.proofTypesAllowed) { %><small class="error-text"><%= errors.proofTypesAllowed %></small><% } %>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Branding & Media</div>
            <div class="media-block <%= errors.logoUrl ? 'has-error' : '' %>">
              <h3>1) Event Logo</h3>
              <p>Small square or transparent image.</p>
              <p class="media-used-in"><strong>Used in:</strong> Event listings, leaderboard header, search results.</p>
              <p class="media-rules">Optional. JPG/PNG only, max 5MB.</p>
              <div class="form-grid">
                <div class="form-group">
                <input type="hidden" id="removeLogoImage" name="removeLogoImage" value="<%= formData.removeLogoImage ? '1' : '0' %>">
                <label for="logoUrl">Logo URL</label>
                <input id="logoUrl" name="logoUrl" type="url" value="<%= formData.logoUrl %>">
                <label for="logoFile" style="margin-top:0.5rem;">or Upload Logo</label>
                <input id="logoFile" name="logoFile" type="file" accept="image/jpeg,image/png">
                <small class="field-hint">Square image recommended (200x200+), JPG/PNG, max 5MB.</small>
                <small class="field-hint">If both URL and file are provided, uploaded file will be used.</small>
                <% if (formData.logoUrl) { %>
                  <div class="branding-preview branding-preview-wrap" id="logoPreviewWrap">
                    <button type="button" class="branding-remove-btn" id="removeLogoBtn" aria-label="Remove current logo image">X</button>
                    <img src="<%= formData.logoUrl %>" alt="Current logo preview" style="max-width:80px;max-height:80px;border-radius:8px;margin-top:0.5rem;">
                  </div>
                <% } %>
                <% if (errors.logoUrl) { %><small class="error-text"><%= errors.logoUrl %></small><% } %>
              </div>
            </div>
          </div>

          <div class="media-block <%= errors.bannerImageUrl ? 'has-error' : '' %>">
            <h3>2) Event Banner</h3>
            <p>Wide rectangular image for event branding.</p>
            <p class="media-used-in"><strong>Used in:</strong> Event page hero section, landing page, promotional header.</p>
            <p class="media-rules">Optional. JPG/PNG only, max 5MB. Recommended ratio: 3:1 (example: 1200x400).</p>
            <div class="form-grid">
              <div class="form-group">
                <input type="hidden" id="removeBannerImage" name="removeBannerImage" value="<%= formData.removeBannerImage ? '1' : '0' %>">
                <label for="bannerImageUrl">Banner Image URL</label>
                <input id="bannerImageUrl" name="bannerImageUrl" type="url" value="<%= formData.bannerImageUrl %>">
                <label for="bannerImageFile" style="margin-top:0.5rem;">or Upload Banner Image</label>
                <input id="bannerImageFile" name="bannerImageFile" type="file" accept="image/jpeg,image/png">
                <small class="field-hint">Recommended ratio: 3:1 (example 1200x400), JPG/PNG, max 5MB.</small>
                <small class="field-hint">If both URL and file are provided, uploaded file will be used.</small>
                <% if (formData.bannerImageUrl) { %>
                  <div class="branding-preview branding-preview-wrap" id="bannerPreviewWrap">
                    <button type="button" class="branding-remove-btn" id="removeBannerBtn" aria-label="Remove current banner image">X</button>
                    <img src="<%= formData.bannerImageUrl %>" alt="Current banner preview" style="max-width:100%;max-height:120px;border-radius:6px;margin-top:0.5rem;">
                  </div>
                <% } %>
                <% if (errors.bannerImageUrl) { %><small class="error-text"><%= errors.bannerImageUrl %></small><% } %>
              </div>
            </div>
          </div>

          <div class="media-block <%= errors.posterImageUrl ? 'has-error' : '' %>">
            <h3>3) Promotional Poster</h3>
            <p>Edited promotional image (details, dates, sponsors, prizes, instructions).</p>
            <p class="media-used-in"><strong>Used in:</strong> Event details page and promotional header blocks.</p>
            <p class="media-rules">Optional. JPG/PNG only, max 5MB.</p>
            <div class="form-grid">
              <div class="form-group">
                <input type="hidden" id="removePosterImage" name="removePosterImage" value="<%= formData.removePosterImage ? '1' : '0' %>">
                <label for="posterImageUrl">Promotional Poster URL</label>
                <input id="posterImageUrl" name="posterImageUrl" type="url" value="<%= formData.posterImageUrl %>">
                <label for="posterImageFile" style="margin-top:0.5rem;">or Upload Promotional Poster</label>
                <input id="posterImageFile" name="posterImageFile" type="file" accept="image/jpeg,image/png">
                <small class="field-hint">JPG/PNG, max 5MB.</small>
                <small class="field-hint">If both URL and file are provided, uploaded file will be used.</small>
                <% if (formData.posterImageUrl) { %>
                  <div class="branding-preview branding-preview-wrap" id="posterPreviewWrap">
                    <button type="button" class="branding-remove-btn" id="removePosterBtn" aria-label="Remove current promotional poster">X</button>
                    <img src="<%= formData.posterImageUrl %>" alt="Current poster preview" style="max-width:100%;max-height:220px;border-radius:8px;margin-top:0.5rem;">
                  </div>
                <% } %>
                <% if (errors.posterImageUrl) { %><small class="error-text"><%= errors.posterImageUrl %></small><% } %>
              </div>
            </div>
          </div>

          <div class="media-block <%= errors.galleryImageUrls ? 'has-error' : '' %>">
            <h3>4) Gallery Images (Optional)</h3>
            <p>Past event photos, route preview, medal preview.</p>
            <p class="media-used-in"><strong>Used in:</strong> Event details gallery section.</p>
            <p class="media-rules">Optional. JPG/PNG only, max 5MB each, up to 12 images.</p>
            <div class="form-grid">
              <div class="form-group">
                <input type="hidden" id="removeGalleryImages" name="removeGalleryImages" value="<%= formData.removeGalleryImages ? '1' : '0' %>">
                <label for="galleryImageUrlsText">Gallery Image URLs</label>
                <textarea id="galleryImageUrlsText" name="galleryImageUrlsText" rows="5" placeholder="One URL per line, or comma-separated"><%= formData.galleryImageUrlsText || '' %></textarea>
                <label for="galleryImageFiles" style="margin-top:0.5rem;">or Upload Gallery Images</label>
                <input id="galleryImageFiles" name="galleryImageFiles" type="file" accept="image/jpeg,image/png" multiple>
                <small class="field-hint">JPG/PNG, max 5MB each, up to 12 images total.</small>
                <% if (formData.galleryImageUrls && formData.galleryImageUrls.length) { %>
                  <div class="gallery-preview-grid" id="galleryPreviewGrid">
                    <% formData.galleryImageUrls.forEach((galleryUrl, galleryIndex) => { %>
                      <div class="gallery-thumb-wrap" data-gallery-url="<%- galleryUrl %>">
                        <button type="button" class="gallery-remove-btn" data-gallery-url="<%- galleryUrl %>" aria-label="Remove gallery image <%= galleryIndex + 1 %>">X</button>
                        <img src="<%= galleryUrl %>" alt="Gallery Preview <%= galleryIndex + 1 %>" class="gallery-preview-thumb">
                      </div>
                    <% }) %>
                  </div>
                  <button type="button" class="btn btn-outline btn-remove-all-gallery" id="removeAllGalleryBtn">Remove all gallery images</button>
                <% } %>
                <% if (errors.galleryImageUrls) { %><small class="error-text"><%= errors.galleryImageUrls %></small><% } %>
              </div>
            </div>
          </div>
        </div>

        <div class="actions">
          <a href="/organizer/events/<%= event._id %>" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </section>
  </main>

  <%- include('../layouts/footer') %>
  <script src="/js/main.js"></script>
  <script>
    if (window.lucide) lucide.createIcons();

    const eventTypeSelect = document.getElementById('eventType');
    const locationSection = document.querySelector('.location-section');
    const virtualSection = document.querySelector('.virtual-section');

    function toggleSections() {
      const val = eventTypeSelect.value;
      locationSection.style.display = (val === 'onsite' || val === 'hybrid') ? 'block' : 'none';
      virtualSection.style.display = (val === 'virtual' || val === 'hybrid') ? 'block' : 'none';
    }

    if (eventTypeSelect) {
      eventTypeSelect.addEventListener('change', toggleSections);
      toggleSections();
    }

    // Branding file validation
    const allowedImageTypes = new Set(['image/jpeg', 'image/png']);
    const maxBrandingSizeBytes = 5 * 1024 * 1024;

    function resetFileInput(input, message) {
      alert(message);
      input.value = '';
    }

    async function removeEventMediaNow(payload) {
      const body = new URLSearchParams(payload);
      const response = await fetch(`/organizer/events/<%= event._id %>/media/remove`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: body.toString()
      });
      let data = null;
      try {
        data = await response.json();
      } catch (error) {
        data = null;
      }
      if (!response.ok || !data || !data.success) {
        const message = (data && data.message) || 'Failed to remove media.';
        throw new Error(message);
      }
      return data;
    }

    async function handleBrandingFileValidation(input, options = {}) {
      const file = input.files && input.files[0];
      if (!file) return;

      if (!allowedImageTypes.has(file.type)) {
        resetFileInput(input, 'Invalid file type. Only JPG and PNG files are allowed.');
        return;
      }
      if (file.size > maxBrandingSizeBytes) {
        resetFileInput(input, 'Image exceeds 5MB limit.');
        return;
      }

      if (options.requireBannerRatio) {
        // Ratio is a recommendation only; no hard block.
      }
    }

    const bannerFileInput = document.getElementById('bannerImageFile');
    const logoFileInput = document.getElementById('logoFile');
    const posterFileInput = document.getElementById('posterImageFile');
    const galleryFilesInput = document.getElementById('galleryImageFiles');
    const removeBannerInput = document.getElementById('removeBannerImage');
    const removeBannerBtn = document.getElementById('removeBannerBtn');
    const bannerPreviewWrap = document.getElementById('bannerPreviewWrap');
    const removeLogoInput = document.getElementById('removeLogoImage');
    const removeLogoBtn = document.getElementById('removeLogoBtn');
    const logoPreviewWrap = document.getElementById('logoPreviewWrap');
    const removePosterInput = document.getElementById('removePosterImage');
    const removePosterBtn = document.getElementById('removePosterBtn');
    const posterPreviewWrap = document.getElementById('posterPreviewWrap');
    const removeGalleryInput = document.getElementById('removeGalleryImages');
    const removeAllGalleryBtn = document.getElementById('removeAllGalleryBtn');
    const galleryPreviewGrid = document.getElementById('galleryPreviewGrid');
    const bannerUrlInput = document.getElementById('bannerImageUrl');
    const logoUrlInput = document.getElementById('logoUrl');
    const posterUrlInput = document.getElementById('posterImageUrl');
    const galleryUrlsTextInput = document.getElementById('galleryImageUrlsText');
    if (bannerFileInput) {
      bannerFileInput.addEventListener('change', () => {
        handleBrandingFileValidation(bannerFileInput, { requireBannerRatio: true });
        if (bannerFileInput.files && bannerFileInput.files.length && removeBannerInput) {
          removeBannerInput.value = '0';
        }
      });
    }
    if (logoFileInput) {
      logoFileInput.addEventListener('change', () => {
        handleBrandingFileValidation(logoFileInput);
        if (logoFileInput.files && logoFileInput.files.length && removeLogoInput) {
          removeLogoInput.value = '0';
        }
      });
    }
    if (posterFileInput) {
      posterFileInput.addEventListener('change', () => {
        handleBrandingFileValidation(posterFileInput);
        if (posterFileInput.files && posterFileInput.files.length && removePosterInput) {
          removePosterInput.value = '0';
        }
      });
    }
    if (galleryFilesInput) {
      galleryFilesInput.addEventListener('change', () => {
        const files = Array.from(galleryFilesInput.files || []);
        if (!files.length) return;
        if (files.length > 12) {
          resetFileInput(galleryFilesInput, 'You can upload up to 12 gallery images at a time.');
          return;
        }
        for (const file of files) {
          if (!allowedImageTypes.has(file.type)) {
            resetFileInput(galleryFilesInput, 'Invalid gallery file type. Only JPG and PNG files are allowed.');
            return;
          }
          if (file.size > maxBrandingSizeBytes) {
            resetFileInput(galleryFilesInput, 'One or more gallery images exceed 5MB limit.');
            return;
          }
        }
        if (removeGalleryInput) removeGalleryInput.value = '0';
      });
    }
    if (removeBannerBtn && removeBannerInput && bannerUrlInput) {
      removeBannerBtn.addEventListener('click', async () => {
        const confirmed = confirm('Remove current banner image?');
        if (!confirmed) return;
        removeBannerBtn.disabled = true;
        try {
          await removeEventMediaNow({ kind: 'banner' });
          removeBannerInput.value = '0';
          bannerUrlInput.value = '';
          if (bannerPreviewWrap) bannerPreviewWrap.style.display = 'none';
        } catch (error) {
          alert(error.message);
        } finally {
          removeBannerBtn.disabled = false;
        }
      });
    }
    if (removeLogoBtn && removeLogoInput && logoUrlInput) {
      removeLogoBtn.addEventListener('click', async () => {
        const confirmed = confirm('Remove current logo image?');
        if (!confirmed) return;
        removeLogoBtn.disabled = true;
        try {
          await removeEventMediaNow({ kind: 'logo' });
          removeLogoInput.value = '0';
          logoUrlInput.value = '';
          if (logoPreviewWrap) logoPreviewWrap.style.display = 'none';
        } catch (error) {
          alert(error.message);
        } finally {
          removeLogoBtn.disabled = false;
        }
      });
    }
    if (removePosterBtn && removePosterInput && posterUrlInput) {
      removePosterBtn.addEventListener('click', async () => {
        const confirmed = confirm('Remove current promotional poster?');
        if (!confirmed) return;
        removePosterBtn.disabled = true;
        try {
          await removeEventMediaNow({ kind: 'poster' });
          removePosterInput.value = '0';
          posterUrlInput.value = '';
          if (posterPreviewWrap) posterPreviewWrap.style.display = 'none';
        } catch (error) {
          alert(error.message);
        } finally {
          removePosterBtn.disabled = false;
        }
      });
    }
    if (removeAllGalleryBtn && removeGalleryInput && galleryUrlsTextInput) {
      removeAllGalleryBtn.addEventListener('click', async () => {
        const confirmed = confirm('Remove all current gallery images?');
        if (!confirmed) return;
        removeAllGalleryBtn.disabled = true;
        try {
          await removeEventMediaNow({ kind: 'gallery', all: '1' });
          removeGalleryInput.value = '0';
          galleryUrlsTextInput.value = '';
          if (galleryPreviewGrid) galleryPreviewGrid.innerHTML = '';
          removeAllGalleryBtn.style.display = 'none';
        } catch (error) {
          alert(error.message);
        } finally {
          removeAllGalleryBtn.disabled = false;
        }
      });
    }

    function normalizeGalleryUrls(rawValue) {
      return String(rawValue || '')
        .split(/\r?\n|,/)
        .map((item) => item.trim())
        .filter(Boolean);
    }

    if (galleryPreviewGrid) {
      galleryPreviewGrid.querySelectorAll('.gallery-remove-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const targetUrl = btn.getAttribute('data-gallery-url');
          if (!targetUrl) return;
          const confirmed = confirm('Remove this gallery image?');
          if (!confirmed) return;
          btn.disabled = true;

          try {
            await removeEventMediaNow({ kind: 'gallery', url: targetUrl });

            const targetWrap = Array.from(galleryPreviewGrid.querySelectorAll('.gallery-thumb-wrap'))
              .find((item) => item.getAttribute('data-gallery-url') === targetUrl);
            if (targetWrap) targetWrap.remove();

            const currentUrls = normalizeGalleryUrls(galleryUrlsTextInput ? galleryUrlsTextInput.value : '');
            const nextUrls = currentUrls.filter((urlValue) => urlValue !== targetUrl);
            if (galleryUrlsTextInput) galleryUrlsTextInput.value = nextUrls.join('\n');
            if (removeGalleryInput) removeGalleryInput.value = nextUrls.length ? '0' : '1';
            if (removeAllGalleryBtn) {
              removeAllGalleryBtn.style.display = nextUrls.length ? 'inline-flex' : 'none';
            }
          } catch (error) {
            alert(error.message);
          } finally {
            btn.disabled = false;
          }
        });
      });
    }

    // Waiver preview
    const waiverTemplateInput = document.getElementById('waiverTemplate');
    const organiserNameInput = document.getElementById('organiserName');
    const titleInput = document.getElementById('title');
    const waiverPreview = document.getElementById('waiverPreview');
    const resetWaiverBtn = document.getElementById('resetWaiverBtn');
    const defaultWaiverTemplate = <%- JSON.stringify(defaultWaiverTemplate || '') %>;

    function renderWaiverPreview() {
      if (!waiverTemplateInput || !waiverPreview) return;
      const organizerName = (organiserNameInput?.value || '').trim() || 'the organizer';
      const eventTitle = (titleInput?.value || '').trim() || 'this event';
      const template = waiverTemplateInput.value || '';
      waiverPreview.innerHTML = template
        .replace(/\{\{\s*ORGANIZER_NAME\s*\}\}/g, organizerName)
        .replace(/\{\{\s*EVENT_TITLE\s*\}\}/g, eventTitle);
    }

    [waiverTemplateInput, organiserNameInput, titleInput].forEach((el) => {
      if (el) el.addEventListener('input', renderWaiverPreview);
    });
    if (resetWaiverBtn && waiverTemplateInput) {
      resetWaiverBtn.addEventListener('click', () => {
        const confirmed = confirm('Reset waiver template to the default version?');
        if (!confirmed) return;
        waiverTemplateInput.value = defaultWaiverTemplate;
        renderWaiverPreview();
      });
    }
    renderWaiverPreview();
  </script>
</body>
</html>
