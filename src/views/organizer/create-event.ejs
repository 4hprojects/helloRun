<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../layouts/head', { title: 'Create Event - helloRun' }) %>
  <link rel="stylesheet" href="/css/create-event.css">
</head>
<body>
  <%- include('../layouts/nav') %>

  <main class="create-event-page">
    <section class="create-event-shell">
      <header class="page-header">
        <h1>Create Event</h1>
        <p>Set up core event details using the Phase 3 event schema.</p>
      </header>

      <% if (message) { %>
        <div class="status-note status-note-<%= message.type %>" role="status">
          <i data-lucide="<%= message.type === 'success' ? 'check-circle' : 'alert-circle' %>"></i>
          <div>
            <strong><%= message.type === 'success' ? 'Success' : 'Attention' %></strong>
            <p><%= message.text %></p>
          </div>
        </div>
      <% } %>

      <% if (Object.keys(errors || {}).length) { %>
        <div class="form-errors" role="alert">
          <strong>Please fix the highlighted fields before submitting.</strong>
        </div>
      <% } %>

      <form class="create-event-form" method="POST" action="/organizer/create-event" enctype="multipart/form-data" novalidate>
        <!-- CORE DETAILS SECTION -->
        <div class="form-section">
          <div class="section-title">üìã Core Details</div>
          <div class="form-grid">
            <div class="form-group <%= errors.title ? 'has-error' : '' %>">
              <label for="title">Event Title *</label>
              <input id="title" name="title" type="text" value="<%= formData.title %>" placeholder="e.g., HelloRun 10K Challenge">
              <% if (errors.title) { %><small class="error-text"><%= errors.title %></small><% } %>
            </div>

            <div class="form-group">
              <label for="organiserName">Organizer Name</label>
              <input id="organiserName" name="organiserName" type="text" value="<%= formData.organiserName %>" placeholder="Defaults to your account name if empty">
            </div>

            <div class="form-group form-group-full <%= errors.description ? 'has-error' : '' %>">
              <label for="description">Description *</label>
              <textarea id="description" name="description" rows="4" placeholder="Describe the event, rules, and expectations."><%= formData.description %></textarea>
              <% if (errors.description) { %><small class="error-text"><%= errors.description %></small><% } %>
            </div>

            <div class="form-group form-group-full <%= errors.eventType ? 'has-error' : '' %>">
              <label for="eventType">Event Type *</label>
              <select id="eventType" name="eventType" required>
                <option value="">Select event type</option>
                <option value="virtual" <%= formData.eventType === 'virtual' ? 'selected' : '' %>>Virtual (Virtual run only)</option>
                <option value="onsite" <%= formData.eventType === 'onsite' ? 'selected' : '' %>>On-site (On-site only)</option>
                <option value="hybrid" <%= formData.eventType === 'hybrid' ? 'selected' : '' %>>Hybrid (Both virtual and on-site)</option>
              </select>
              <% if (errors.eventType) { %><small class="error-text"><%= errors.eventType %></small><% } %>
            </div>

            <div class="form-group form-group-full <%= errors.raceDistances ? 'has-error' : '' %>">
              <label>Race Distances *</label>
              <div class="checkbox-row">
                <% const selectedDistances = formData.raceDistancePresets || []; %>
                <label><input type="checkbox" name="raceDistancePresets" value="3K" <%= selectedDistances.includes('3K') ? 'checked' : '' %>> 3K</label>
                <label><input type="checkbox" name="raceDistancePresets" value="5K" <%= selectedDistances.includes('5K') ? 'checked' : '' %>> 5K</label>
                <label><input type="checkbox" name="raceDistancePresets" value="10K" <%= selectedDistances.includes('10K') ? 'checked' : '' %>> 10K</label>
                <label><input type="checkbox" name="raceDistancePresets" value="21K" <%= selectedDistances.includes('21K') ? 'checked' : '' %>> 21K</label>
              </div>
              <label for="raceDistanceCustom" style="margin-top:0.5rem;">Custom Distances (comma-separated)</label>
              <input id="raceDistanceCustom" name="raceDistanceCustom" type="text" value="<%= formData.raceDistanceCustom || '' %>" placeholder="e.g., 42K, 50K">
              <small class="field-hint">Final values are normalized like 3K, 5K, 10K.</small>
              <% if (errors.raceDistances) { %><small class="error-text"><%= errors.raceDistances %></small><% } %>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Waiver (Required)</div>
          <div class="form-grid">
            <div class="form-group form-group-full <%= errors.waiverTemplate ? 'has-error' : '' %>">
              <label for="waiverTemplate">Waiver Template HTML *</label>
              <div class="waiver-toolbar">
                <button type="button" id="resetWaiverBtn" class="btn btn-outline">Reset to Default Waiver</button>
              </div>
              <textarea
                id="waiverTemplate"
                name="waiverTemplate"
                rows="14"
                placeholder="Enter waiver HTML template"
              ><%= formData.waiverTemplate %></textarea>
              <small class="field-hint">
                Use placeholders: <code>{{ORGANIZER_NAME}}</code> and <code>{{EVENT_TITLE}}</code>.
              </small>
              <% if (errors.waiverTemplate) { %><small class="error-text"><%= errors.waiverTemplate %></small><% } %>
            </div>

            <div class="form-group form-group-full">
              <label>Waiver Preview</label>
              <div id="waiverPreview" class="waiver-preview-box"></div>
              <small class="field-hint">
                Preview replaces placeholders using current Organizer Name and Event Title values.
              </small>
            </div>
          </div>
        </div>

        <!-- SCHEDULE SECTION -->
        <div class="form-section">
          <div class="section-title">üìÖ Schedule</div>
          <div class="form-grid">
            <div class="form-group <%= errors.registrationOpenAt ? 'has-error' : '' %>">
              <label for="registrationOpenAt">Registration Open *</label>
              <div class="input-with-button">
                <input id="registrationOpenAt" name="registrationOpenAt" type="datetime-local" value="<%= formData.registrationOpenAt %>">
                <button type="button" class="btn-now" data-target="registrationOpenAt">Now</button>
              </div>
              <small class="field-hint">Local date and time</small>
              <% if (errors.registrationOpenAt) { %><small class="error-text"><%= errors.registrationOpenAt %></small><% } %>
            </div>
            <div class="form-group <%= errors.registrationCloseAt ? 'has-error' : '' %>">
              <label for="registrationCloseAt">Registration Close *</label>
              <div class="input-with-button">
                <input id="registrationCloseAt" name="registrationCloseAt" type="datetime-local" value="<%= formData.registrationCloseAt %>">
                <button type="button" class="btn-now" data-target="registrationCloseAt">Now</button>
              </div>
              <small class="field-hint">Local date and time</small>
              <% if (errors.registrationCloseAt) { %><small class="error-text"><%= errors.registrationCloseAt %></small><% } %>
            </div>
            <div class="form-group <%= errors.eventStartAt ? 'has-error' : '' %>">
              <label for="eventStartAt">Event Start *</label>
              <div class="input-with-button">
                <input id="eventStartAt" name="eventStartAt" type="datetime-local" value="<%= formData.eventStartAt %>">
                <button type="button" class="btn-now" data-target="eventStartAt">Now</button>
              </div>
              <small class="field-hint">Local date and time</small>
              <% if (errors.eventStartAt) { %><small class="error-text"><%= errors.eventStartAt %></small><% } %>
            </div>
            <div class="form-group <%= errors.eventEndAt ? 'has-error' : '' %>">
              <label for="eventEndAt">Event End *</label>
              <div class="input-with-button">
                <input id="eventEndAt" name="eventEndAt" type="datetime-local" value="<%= formData.eventEndAt %>">
                <button type="button" class="btn-now" data-target="eventEndAt">Now</button>
              </div>
              <small class="field-hint">Local date and time</small>
              <% if (errors.eventEndAt) { %><small class="error-text"><%= errors.eventEndAt %></small><% } %>
            </div>
          </div>
        </div>

        <!-- LOCATION SECTION (conditional) -->
        <div class="form-section location-section" style="display: none;">
          <div class="section-title">üìç Location (required for on-site/hybrid)</div>
          <div class="form-grid">
            <div class="form-group <%= errors.venueName ? 'has-error' : '' %>">
              <label for="venueName">Venue Name</label>
              <input id="venueName" name="venueName" type="text" value="<%= formData.venueName %>">
              <% if (errors.venueName) { %><small class="error-text"><%= errors.venueName %></small><% } %>
            </div>

            <div class="form-group <%= errors.city ? 'has-error' : '' %>">
              <label for="city">City</label>
              <input id="city" name="city" type="text" value="<%= formData.city %>">
              <% if (errors.city) { %><small class="error-text"><%= errors.city %></small><% } %>
            </div>

            <div class="form-group form-group-full <%= errors.venueAddress ? 'has-error' : '' %>">
              <label for="venueAddress">Venue Address</label>
              <input id="venueAddress" name="venueAddress" type="text" value="<%= formData.venueAddress %>">
              <% if (errors.venueAddress) { %><small class="error-text"><%= errors.venueAddress %></small><% } %>
            </div>

            <div class="form-group">
              <label for="province">Province/State</label>
              <input id="province" name="province" type="text" value="<%= formData.province %>">
            </div>

            <div class="form-group <%= errors.country ? 'has-error' : '' %>">
              <label for="country">Country</label>
              <% const countryCodes = (countries || []).map((item) => item.code); %>
              <select id="country" name="country">
                <option value="">Select country</option>
                <% (countries || []).forEach((item) => { %>
                  <option value="<%= item.code %>" <%= formData.country === item.code ? 'selected' : '' %>><%= item.name %></option>
                <% }); %>
                <% if (formData.country && !countryCodes.includes(formData.country)) { %>
                  <option value="<%= formData.country %>" selected><%= formData.country %> (legacy)</option>
                <% } %>
              </select>
              <% if (errors.country) { %><small class="error-text"><%= errors.country %></small><% } %>
            </div>

            <div class="form-group <%= errors.geoLat ? 'has-error' : '' %>">
              <label for="geoLat">Latitude (optional)</label>
              <input id="geoLat" name="geoLat" type="text" value="<%= formData.geoLat %>" placeholder="e.g., 14.5995">
              <% if (errors.geoLat) { %><small class="error-text"><%= errors.geoLat %></small><% } %>
            </div>

            <div class="form-group <%= errors.geoLng ? 'has-error' : '' %>">
              <label for="geoLng">Longitude (optional)</label>
              <input id="geoLng" name="geoLng" type="text" value="<%= formData.geoLng %>" placeholder="e.g., 120.9842">
              <% if (errors.geoLng) { %><small class="error-text"><%= errors.geoLng %></small><% } %>
              <% if (errors.geo) { %><small class="error-text"><%= errors.geo %></small><% } %>
            </div>
          </div>
        </div>

        <!-- VIRTUAL RULES SECTION (conditional) -->
        <div class="form-section virtual-section" style="display: none;">
          <div class="section-title">üèÉ Virtual Rules (required for virtual/hybrid)</div>
          <div class="form-grid">
            <div class="form-group <%= errors.virtualStartAt ? 'has-error' : '' %>">
              <label for="virtualStartAt">Virtual Window Start</label>
              <div class="input-with-button">
                <input id="virtualStartAt" name="virtualStartAt" type="datetime-local" value="<%= formData.virtualStartAt %>">
                <button type="button" class="btn-now" data-target="virtualStartAt">Now</button>
              </div>
              <small class="field-hint">Local date and time</small>
              <% if (errors.virtualStartAt) { %><small class="error-text"><%= errors.virtualStartAt %></small><% } %>
            </div>

            <div class="form-group <%= errors.virtualEndAt ? 'has-error' : '' %>">
              <label for="virtualEndAt">Virtual Window End</label>
              <div class="input-with-button">
                <input id="virtualEndAt" name="virtualEndAt" type="datetime-local" value="<%= formData.virtualEndAt %>">
                <button type="button" class="btn-now" data-target="virtualEndAt">Now</button>
              </div>
              <small class="field-hint">Local date and time</small>
              <% if (errors.virtualEndAt) { %><small class="error-text"><%= errors.virtualEndAt %></small><% } %>
            </div>

            <div class="form-group form-group-full <%= errors.proofTypesAllowed ? 'has-error' : '' %>">
              <label>Proof Types Allowed</label>
              <div class="checkbox-row">
                <% const selectedProofs = formData.proofTypesAllowed || []; %>
                <label><input type="checkbox" name="proofTypesAllowed" value="gps" <%= selectedProofs.includes('gps') ? 'checked' : '' %>> GPS</label>
                <label><input type="checkbox" name="proofTypesAllowed" value="photo" <%= selectedProofs.includes('photo') ? 'checked' : '' %>> Photo</label>
                <label><input type="checkbox" name="proofTypesAllowed" value="manual" <%= selectedProofs.includes('manual') ? 'checked' : '' %>> Manual</label>
              </div>
              <% if (errors.proofTypesAllowed) { %><small class="error-text"><%= errors.proofTypesAllowed %></small><% } %>
            </div>
          </div>
        </div>

        <!-- BRANDING SECTION -->
        <div class="form-section">
          <div class="section-title">Branding & Media</div>
          <div class="media-block <%= errors.logoUrl ? 'has-error' : '' %>">
            <h3>1) Event Logo</h3>
            <p>Small square or transparent image.</p>
            <p class="media-used-in"><strong>Used in:</strong> Event listings, leaderboard header, search results.</p>
            <p class="media-rules">Optional. JPG/PNG only, max 5MB.</p>
            <div class="form-grid">
              <div class="form-group">
                <label for="logoUrl">Logo URL</label>
                <input id="logoUrl" name="logoUrl" type="url" value="<%= formData.logoUrl %>" placeholder="https://...">
                <label for="logoFile" style="margin-top:0.5rem;">or Upload Logo</label>
                <input id="logoFile" name="logoFile" type="file" accept="image/jpeg,image/png">
                <small class="field-hint">Square image recommended (200x200+), JPG/PNG, max 5MB.</small>
                <small class="field-hint">If both URL and file are provided, uploaded file will be used.</small>
                <% if (errors.logoUrl) { %><small class="error-text"><%= errors.logoUrl %></small><% } %>
                <% if (formData.logoUrl) { %>
                <div class="branding-preview">
                  <img id="logoPreview" src="<%= formData.logoUrl %>" alt="Logo Preview" style="max-width:80px;max-height:80px;border-radius:8px;margin-top:0.5rem;">
                </div>
                <% } %>
              </div>
            </div>
          </div>

          <div class="media-block <%= errors.bannerImageUrl ? 'has-error' : '' %>">
            <h3>2) Event Banner</h3>
            <p>Wide rectangular image for event branding.</p>
            <p class="media-used-in"><strong>Used in:</strong> Event page hero section, landing page, promotional header.</p>
            <p class="media-rules">Optional. JPG/PNG only, max 5MB. Recommended ratio: 3:1 (example: 1200x400).</p>
            <div class="form-grid">
              <div class="form-group">
                <label for="bannerImageUrl">Banner Image URL</label>
                <input id="bannerImageUrl" name="bannerImageUrl" type="url" value="<%= formData.bannerImageUrl %>" placeholder="https://...">
                <label for="bannerImageFile" style="margin-top:0.5rem;">or Upload Banner Image</label>
                <input id="bannerImageFile" name="bannerImageFile" type="file" accept="image/jpeg,image/png">
                <small class="field-hint">Recommended ratio: 3:1 (example 1200x400), JPG/PNG, max 5MB.</small>
                <small class="field-hint">If both URL and file are provided, uploaded file will be used.</small>
                <% if (errors.bannerImageUrl) { %><small class="error-text"><%= errors.bannerImageUrl %></small><% } %>
                <% if (formData.bannerImageUrl) { %>
                <div class="branding-preview">
                  <img id="bannerPreview" src="<%= formData.bannerImageUrl %>" alt="Banner Preview" style="max-width:100%;max-height:120px;border-radius:6px;margin-top:0.5rem;">
                </div>
                <% } %>
              </div>
            </div>
          </div>

          <div class="media-block <%= errors.posterImageUrl ? 'has-error' : '' %>">
            <h3>3) Promotional Poster</h3>
            <p>Edited promotional image (details, dates, sponsors, prizes, instructions).</p>
            <p class="media-used-in"><strong>Used in:</strong> Event details page and promotional header blocks.</p>
            <p class="media-rules">Optional. JPG/PNG only, max 5MB.</p>
            <div class="form-grid">
              <div class="form-group">
                <label for="posterImageUrl">Promotional Poster URL</label>
                <input id="posterImageUrl" name="posterImageUrl" type="url" value="<%= formData.posterImageUrl %>" placeholder="https://...">
                <label for="posterImageFile" style="margin-top:0.5rem;">or Upload Promotional Poster</label>
                <input id="posterImageFile" name="posterImageFile" type="file" accept="image/jpeg,image/png">
                <small class="field-hint">JPG/PNG, max 5MB.</small>
                <small class="field-hint">If both URL and file are provided, uploaded file will be used.</small>
                <% if (errors.posterImageUrl) { %><small class="error-text"><%= errors.posterImageUrl %></small><% } %>
                <% if (formData.posterImageUrl) { %>
                <div class="branding-preview">
                  <img id="posterPreview" src="<%= formData.posterImageUrl %>" alt="Poster Preview" style="max-width:100%;max-height:220px;border-radius:8px;margin-top:0.5rem;">
                </div>
                <% } %>
              </div>
            </div>
          </div>

          <div class="media-block <%= errors.galleryImageUrls ? 'has-error' : '' %>">
            <h3>4) Gallery Images (Optional)</h3>
            <p>Past event photos, route preview, medal preview.</p>
            <p class="media-used-in"><strong>Used in:</strong> Event details gallery section.</p>
            <p class="media-rules">Optional. JPG/PNG only, max 5MB each, up to 12 images.</p>
            <div class="form-grid">
              <div class="form-group">
                <label for="galleryImageUrlsText">Gallery Image URLs</label>
                <textarea id="galleryImageUrlsText" name="galleryImageUrlsText" rows="5" placeholder="One URL per line, or comma-separated"><%= formData.galleryImageUrlsText || '' %></textarea>
                <label for="galleryImageFiles" style="margin-top:0.5rem;">or Upload Gallery Images</label>
                <input id="galleryImageFiles" name="galleryImageFiles" type="file" accept="image/jpeg,image/png" multiple>
                <small class="field-hint">JPG/PNG, max 5MB each, up to 12 images total.</small>
                <% if (errors.galleryImageUrls) { %><small class="error-text"><%= errors.galleryImageUrls %></small><% } %>
                <% if (formData.galleryImageUrls && formData.galleryImageUrls.length) { %>
                <div class="gallery-preview-grid">
                  <% formData.galleryImageUrls.forEach((galleryUrl, galleryIndex) => { %>
                    <img src="<%= galleryUrl %>" alt="Gallery Preview <%= galleryIndex + 1 %>" class="gallery-preview-thumb">
                  <% }) %>
                </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- FORM ACTIONS -->
        <div class="actions">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='/organizer/dashboard'">
            ‚Üê Back to Dashboard
          </button>
          <button type="button" class="btn btn-outline" id="previewBtn">Preview</button>
          <button type="submit" name="actionType" value="draft" class="btn btn-outline">Save Draft</button>
          <button type="submit" name="actionType" value="publish" class="btn btn-primary" id="publishBtn">
            <span class="btn-text">Publish Event</span>
            <span class="spinner" style="display: none;"></span>
          </button>
        </div>
      </form>
    </section>
  </main>

  <%- include('../layouts/footer') %>

  <script src="/js/main.js"></script>
  <script>
    lucide.createIcons();

    // ---------- CONDITIONAL SECTIONS (based on event type) ----------
    const eventTypeSelect = document.getElementById('eventType');
    const locationSection = document.querySelector('.location-section');
    const virtualSection = document.querySelector('.virtual-section');

    function toggleSections() {
      const val = eventTypeSelect.value;
      locationSection.style.display = (val === 'onsite' || val === 'hybrid') ? 'block' : 'none';
      virtualSection.style.display = (val === 'virtual' || val === 'hybrid') ? 'block' : 'none';
    }

    if (eventTypeSelect) {
      eventTypeSelect.addEventListener('change', toggleSections);
      toggleSections(); // set initial state
    }

    // ---------- "NOW" BUTTONS FOR DATETIME FIELDS ----------
    document.querySelectorAll('.btn-now').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.dataset.target;
        const input = document.getElementById(targetId);
        if (!input) return;
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        input.value = `${year}-${month}-${day}T${hours}:${minutes}`;
      });
    });

    // ---------- PREVIEW BUTTON ----------
    document.getElementById('previewBtn')?.addEventListener('click', () => {
      const form = document.querySelector('.create-event-form');
      const formData = new FormData(form);
      const params = new URLSearchParams(formData).toString();
      // Open preview in new tab (you need to implement the preview route)
      window.open(`/organizer/preview-event?${params}`, '_blank');
    });

    // ---------- LOADING STATE ON PUBLISH ----------
    const form = document.querySelector('.create-event-form');
    const publishBtn = document.getElementById('publishBtn');

    form.addEventListener('submit', (e) => {
      const submitter = e.submitter;
      if (submitter && submitter.value === 'publish') {
        // Confirm before publishing
        if (!confirm('Are you sure you want to publish this event? It will be visible to participants.')) {
          e.preventDefault();
          return;
        }
        // Disable button and show spinner
        publishBtn.disabled = true;
        publishBtn.querySelector('.btn-text').style.display = 'none';
        publishBtn.querySelector('.spinner').style.display = 'inline-block';
      }
    });

    // Branding live preview
    function updateBrandingPreview(inputId, imgId) {
      const input = document.getElementById(inputId);
      let img = document.getElementById(imgId);
      if (!input) return;

      if (!img) {
        const wrapper = document.createElement('div');
        wrapper.className = 'branding-preview';
        img = document.createElement('img');
        img.id = imgId;
        const isBanner = inputId === 'bannerImageUrl';
        const isPoster = inputId === 'posterImageUrl';
        img.alt = isBanner ? 'Banner Preview' : (isPoster ? 'Poster Preview' : 'Logo Preview');
        img.style.maxWidth = isBanner || isPoster ? '100%' : '80px';
        img.style.maxHeight = isBanner ? '120px' : (isPoster ? '220px' : '80px');
        img.style.borderRadius = isBanner ? '6px' : '8px';
        img.style.marginTop = '0.5rem';
        img.style.display = 'none';
        wrapper.appendChild(img);
        input.parentElement.appendChild(wrapper);
      }

      input.addEventListener('input', () => {
        if (input.value) {
          img.src = input.value;
          img.style.display = 'block';
        } else {
          img.style.display = 'none';
        }
      });
    }
    updateBrandingPreview('bannerImageUrl', 'bannerPreview');
    updateBrandingPreview('logoUrl', 'logoPreview');
    updateBrandingPreview('posterImageUrl', 'posterPreview');

    // Branding file validation
    const allowedImageTypes = new Set(['image/jpeg', 'image/png']);
    const maxBrandingSizeBytes = 5 * 1024 * 1024;

    function resetFileInput(input, message) {
      alert(message);
      input.value = '';
    }

    async function handleBrandingFileValidation(input, options = {}) {
      const file = input.files && input.files[0];
      if (!file) return;

      if (!allowedImageTypes.has(file.type)) {
        resetFileInput(input, 'Invalid file type. Only JPG and PNG files are allowed.');
        return;
      }
      if (file.size > maxBrandingSizeBytes) {
        resetFileInput(input, 'Image exceeds 5MB limit.');
        return;
      }

      if (options.requireBannerRatio) {
        // Ratio is a recommendation only; no hard block.
      }
    }

    const bannerFileInput = document.getElementById('bannerImageFile');
    const logoFileInput = document.getElementById('logoFile');
    const posterFileInput = document.getElementById('posterImageFile');
    const galleryFilesInput = document.getElementById('galleryImageFiles');
    if (bannerFileInput) {
      bannerFileInput.addEventListener('change', () => handleBrandingFileValidation(bannerFileInput, { requireBannerRatio: true }));
    }
    if (logoFileInput) {
      logoFileInput.addEventListener('change', () => handleBrandingFileValidation(logoFileInput));
    }
    if (posterFileInput) {
      posterFileInput.addEventListener('change', () => handleBrandingFileValidation(posterFileInput));
    }
    if (galleryFilesInput) {
      galleryFilesInput.addEventListener('change', () => {
        const files = Array.from(galleryFilesInput.files || []);
        if (!files.length) return;
        if (files.length > 12) {
          resetFileInput(galleryFilesInput, 'You can upload up to 12 gallery images at a time.');
          return;
        }
        for (const file of files) {
          if (!allowedImageTypes.has(file.type)) {
            resetFileInput(galleryFilesInput, 'Invalid gallery file type. Only JPG and PNG files are allowed.');
            return;
          }
          if (file.size > maxBrandingSizeBytes) {
            resetFileInput(galleryFilesInput, 'One or more gallery images exceed 5MB limit.');
            return;
          }
        }
      });
    }

    // Waiver preview
    const waiverTemplateInput = document.getElementById('waiverTemplate');
    const organiserNameInput = document.getElementById('organiserName');
    const titleInput = document.getElementById('title');
    const waiverPreview = document.getElementById('waiverPreview');
    const resetWaiverBtn = document.getElementById('resetWaiverBtn');
    const defaultWaiverTemplate = <%- JSON.stringify(defaultWaiverTemplate || '') %>;

    function renderWaiverPreview() {
      if (!waiverTemplateInput || !waiverPreview) return;
      const organizerName = (organiserNameInput?.value || '').trim() || 'the organizer';
      const eventTitle = (titleInput?.value || '').trim() || 'this event';
      const template = waiverTemplateInput.value || '';
      waiverPreview.innerHTML = template
        .replace(/\{\{\s*ORGANIZER_NAME\s*\}\}/g, organizerName)
        .replace(/\{\{\s*EVENT_TITLE\s*\}\}/g, eventTitle);
    }

    [waiverTemplateInput, organiserNameInput, titleInput].forEach((el) => {
      if (el) el.addEventListener('input', renderWaiverPreview);
    });
    if (resetWaiverBtn && waiverTemplateInput) {
      resetWaiverBtn.addEventListener('click', () => {
        const confirmed = confirm('Reset waiver template to the default version?');
        if (!confirmed) return;
        waiverTemplateInput.value = defaultWaiverTemplate;
        renderWaiverPreview();
      });
    }
    renderWaiverPreview();
  </script>
</body>
</html>

