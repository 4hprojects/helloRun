<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../layouts/head', { title: title }) %>
  <link rel="stylesheet" href="/css/events.css">
</head>
<body>
  <%- include('../layouts/nav') %>

  <main class="event-register-page">
    <section class="event-register-shell">
      <header class="event-register-header">
        <a href="/events/<%= event.slug %>" class="btn btn-secondary">Back to Event</a>
        <h1>Register: <%= event.title %></h1>
      </header>

      <% if (message) { %>
        <div class="page-message page-message-<%= message.type %>"><%= message.text %></div>
      <% } %>

      <% if (existingRegistration) { %>
        <section class="registration-summary registration-summary-success">
          <h2><%= justRegistered ? 'Registration Confirmed' : 'Already Registered' %></h2>
          <p>Your account is registered for this event.</p>
          <div class="registration-summary-grid">
            <p><strong>Confirmation Code:</strong> <code><%= existingRegistration.confirmationCode %></code></p>
            <p><strong>Race Distance:</strong> <%= existingRegistration.raceDistance || 'N/A' %></p>
            <p><strong>Participation Mode:</strong> <%= existingRegistration.participationMode %></p>
            <p><strong>Status:</strong> <%= existingRegistration.status %></p>
            <p><strong>Payment Status:</strong> <%= existingRegistration.paymentStatus %></p>
            <p><strong>Registered At:</strong> <%= existingRegistration.registeredAt ? new Date(existingRegistration.registeredAt).toLocaleString('en-US') : 'N/A' %></p>
          </div>
        </section>
      <% } %>

      <% if (registrationWindowError) { %>
        <div class="page-message page-message-error"><%= registrationWindowError %></div>
      <% } %>

      <% if (errors && errors.base) { %>
        <div class="page-message page-message-error"><%= errors.base %></div>
      <% } %>

      <% if (!existingRegistration) { %>
      <form method="POST" action="/events/<%= event.slug %>/register" class="event-register-form" id="eventRegisterForm">
        <div class="register-grid">
          <div class="form-group form-group-full">
            <label>Runner Profile Snapshot</label>
            <div class="registration-summary registration-summary-info">
              <p><strong>Name:</strong> <%= [formData.firstName, formData.lastName].filter(Boolean).join(' ') || 'Not set' %></p>
              <p><strong>Email:</strong> <%= formData.email || 'Not set' %></p>
              <p><strong>Mobile:</strong> <%= formData.mobile || 'Not set' %></p>
              <p><strong>Country:</strong> <%= formData.country || 'Not set' %></p>
              <p><strong>Date of Birth:</strong> <%= formData.dateOfBirth || 'Not set' %></p>
              <p><strong>Gender:</strong> <%= formData.gender || 'Not set' %></p>
              <p><strong>Emergency Contact:</strong> <%= formData.emergencyContactName && formData.emergencyContactNumber ? `${formData.emergencyContactName} (${formData.emergencyContactNumber})` : 'Not set' %></p>
              <p><strong>Running Group:</strong> <%= formData.runningGroup || 'Not set' %></p>
            </div>
            <small class="field-hint">
              Profile details are pulled from your dashboard and saved as a registration snapshot.
              <a href="/runner/dashboard">Update profile</a>
            </small>
          </div>

          <div class="form-group <%= errors.participationMode ? 'has-error' : '' %>">
            <label for="participationMode">Participation Mode *</label>
            <select id="participationMode" name="participationMode" <%= existingRegistration || registrationWindowError ? 'disabled' : '' %>>
              <% allowedModes.forEach((mode) => { %>
                <option value="<%= mode %>" <%= formData.participationMode === mode ? 'selected' : '' %>><%= mode %></option>
              <% }) %>
            </select>
            <% if (errors.participationMode) { %><small class="error-text"><%= errors.participationMode %></small><% } %>
          </div>

          <div class="form-group <%= errors.raceDistance ? 'has-error' : '' %>">
            <label for="raceDistance">Race Distance *</label>
            <select id="raceDistance" name="raceDistance" <%= existingRegistration || registrationWindowError ? 'disabled' : '' %>>
              <% allowedRaceDistances.forEach((distance) => { %>
                <option value="<%= distance %>" <%= formData.raceDistance === distance ? 'selected' : '' %>><%= distance %></option>
              <% }) %>
            </select>
            <% if (errors.raceDistance) { %><small class="error-text"><%= errors.raceDistance %></small><% } %>
          </div>

          <% if (requiresEmergencyContact) { %>
            <div class="form-group <%= errors.emergencyContactName ? 'has-error' : '' %>">
              <label for="emergencyContactName">Emergency Contact Name *</label>
              <input
                id="emergencyContactName"
                name="emergencyContactName"
                type="text"
                value="<%= formData.emergencyContactName || '' %>"
                <%= existingRegistration || registrationWindowError ? 'disabled' : '' %>
              >
              <% if (errors.emergencyContactName) { %><small class="error-text"><%= errors.emergencyContactName %></small><% } %>
            </div>

            <div class="form-group <%= errors.emergencyContactNumber ? 'has-error' : '' %>">
              <label for="emergencyContactNumber">Emergency Contact Number *</label>
              <input
                id="emergencyContactNumber"
                name="emergencyContactNumber"
                type="text"
                value="<%= formData.emergencyContactNumber || '' %>"
                <%= existingRegistration || registrationWindowError ? 'disabled' : '' %>
              >
              <% if (errors.emergencyContactNumber) { %><small class="error-text"><%= errors.emergencyContactNumber %></small><% } %>
            </div>
          <% } %>

          <div class="form-group form-group-full <%= (errors.waiverAccepted || errors.waiverSignature) ? 'has-error' : '' %>">
            <label>Waiver and Signature *</label>
            <div class="waiver-section">
              <div class="waiver-content">
                <%- waiverHtml %>
              </div>

              <div class="waiver-actions">
                <label class="waiver-checkbox-row" for="waiverAccepted">
                  <input
                    type="checkbox"
                    id="waiverAccepted"
                    name="waiverAccepted"
                    value="1"
                    <%= formData.waiverAccepted ? 'checked' : '' %>
                    <%= existingRegistration || registrationWindowError ? 'disabled' : '' %>
                  >
                  <span>I agree to the waiver (version <%= waiverVersion %>).</span>
                </label>
                <% if (errors.waiverAccepted) { %><small class="error-text"><%= errors.waiverAccepted %></small><% } %>

                <label for="waiverSignature">Digital Signature (type your full account name) *</label>
                <input
                  id="waiverSignature"
                  name="waiverSignature"
                  type="text"
                  value="<%= formData.waiverSignature || '' %>"
                  placeholder="Type your full name"
                  <%= existingRegistration || registrationWindowError ? 'disabled' : '' %>
                >
                <% if (errors.waiverSignature) { %><small class="error-text"><%= errors.waiverSignature %></small><% } %>
              </div>
            </div>
          </div>
        </div>

        <div class="register-actions">
          <% if (!existingRegistration && !registrationWindowError) { %>
            <button type="submit" class="btn" id="confirmRegistrationBtn">Confirm Registration</button>
          <% } %>
          <a href="/events/<%= event.slug %>" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
      <% } else { %>
        <div class="register-actions">
          <a href="/events/<%= event.slug %>" class="btn btn-secondary">Back to Event</a>
        </div>
      <% } %>
    </section>
  </main>

  <%- include('../layouts/footer') %>
  <script src="/js/main.js"></script>
  <script>
    if (window.lucide) lucide.createIcons();

    const form = document.getElementById('eventRegisterForm');
    const submitBtn = document.getElementById('confirmRegistrationBtn');
    if (form && submitBtn) {
      form.addEventListener('submit', (event) => {
        if (!confirm('Confirm your registration for this event?')) {
          event.preventDefault();
          return;
        }
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      });
    }
  </script>
</body>
</html>
